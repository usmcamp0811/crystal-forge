stages:
  - check
  - bump

flake-check:
  stage: check
  tags:
    - nix
  script:
    - nix flake check
  only:
    - merge_requests
    - main

auto-bump-patch:
  stage: bump
  tags:
    - nix
  script:
    - |
      # Get current version
      CURRENT=$(grep '^version =' packages/default/Cargo.toml | cut -d'"' -f2)
      echo "Current version: $CURRENT"

      # Increment patch version
      IFS='.' read -r major minor patch <<< "$CURRENT"
      NEW_VERSION="$major.$minor.$((patch + 1))"
      echo "Bumping to: $NEW_VERSION"

      # Update Cargo.toml
      sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" packages/default/Cargo.toml

      # Update any other version references (README, etc.)
      # sed -i "s/v$CURRENT/v$NEW_VERSION/g" README.md

      # Commit and push
      git config user.name "Crystal Forge CI"
      git config user.email "ci@crystal-forge"
      git add packages/default/Cargo.toml
      git commit -m "chore: auto-bump version to $NEW_VERSION [skip ci]"
      git push origin HEAD:main

      # Create tag for this patch release
      git tag "v$NEW_VERSION"
      git push origin "v$NEW_VERSION"

      echo "✅ Successfully bumped to v$NEW_VERSION"
  only:
    - main
  when: on_success

# Manual job for major/minor bumps
manual-version-bump:
  stage: bump
  tags:
    - nix
  script:
    - |
      echo "Current version: $(grep '^version =' packages/default/Cargo.toml | cut -d'"' -f2)"
      echo "Set NEW_VERSION variable to desired version (e.g., 0.2.0)"

      if [ -z "$NEW_VERSION" ]; then
        echo "❌ NEW_VERSION variable required"
        exit 1
      fi

      sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" packages/default/Cargo.toml

      git config user.name "Crystal Forge CI"
      git config user.email "ci@crystal-forge"
      git add packages/default/Cargo.toml
      git commit -m "chore: bump to v$NEW_VERSION"
      git push origin HEAD:main

      git tag "v$NEW_VERSION"
      git push origin "v$NEW_VERSION"
  only:
    - main
  when: manual
  variables:
    NEW_VERSION: "" # Set this when running manually
