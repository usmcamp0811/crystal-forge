{
  "db_name": "PostgreSQL",
  "query": "\n        WITH latest_commit AS (\n          SELECT id, flake_id, git_commit_hash\n          FROM commits\n          WHERE flake_id = $1\n          ORDER BY commit_timestamp DESC\n          LIMIT 1\n        ),\n        per_host AS (\n          SELECT\n            d.derivation_name AS hostname,\n            d.id              AS derivation_id,\n            d.derivation_target,\n            d.store_path,\n            f.repo_url        AS repo_url,\n            lc.git_commit_hash AS commit_hash,\n            MAX(cpj.completed_at) AS last_cache_completed_at,\n            ROW_NUMBER() OVER (\n              PARTITION BY d.derivation_name\n              ORDER BY\n                MAX(cpj.completed_at) DESC NULLS LAST,\n                MAX(d.completed_at)   DESC NULLS LAST,\n                MAX(d.id)             DESC\n            ) AS rn\n          FROM derivations d\n          JOIN latest_commit lc\n            ON d.commit_id = lc.id\n          JOIN flakes f\n            ON lc.flake_id = f.id\n          JOIN cache_push_jobs cpj\n            ON cpj.derivation_id = d.id\n           AND cpj.status = 'completed'\n          WHERE d.derivation_type = 'nixos'\n            AND d.derivation_target IS NOT NULL\n            AND d.derivation_name = ANY($2::text[])\n          GROUP BY\n            d.derivation_name,\n            d.id,\n            d.derivation_target,\n            d.store_path,\n            f.repo_url,\n            lc.git_commit_hash\n        )\n        SELECT\n          hostname,\n          derivation_id,\n          derivation_target,\n          store_path,\n          last_cache_completed_at,\n          repo_url,\n          commit_hash\n        FROM per_host\n        WHERE rn = 1\n        ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "hostname",
        "type_info": "Text"
      },
      {
        "ordinal": 1,
        "name": "derivation_id",
        "type_info": "Int4"
      },
      {
        "ordinal": 2,
        "name": "derivation_target",
        "type_info": "Text"
      },
      {
        "ordinal": 3,
        "name": "store_path",
        "type_info": "Text"
      },
      {
        "ordinal": 4,
        "name": "last_cache_completed_at",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 5,
        "name": "repo_url",
        "type_info": "Text"
      },
      {
        "ordinal": 6,
        "name": "commit_hash",
        "type_info": "Text"
      }
    ],
    "parameters": {
      "Left": [
        "Int4",
        "TextArray"
      ]
    },
    "nullable": [
      false,
      false,
      true,
      true,
      null,
      false,
      false
    ]
  },
  "hash": "6b7b6166eed6564ee06b11ce165aa4cc685886f3fe2b97212ef4b727e14dcb63"
}
