Weâ€™re running `nix-eval-jobs` from a Rust service under systemd to enumerate `flake.nixosConfigurations`.
It works interactively but fails in the service due to environmental differences and how Nix resolves flakes.

Initially, the Rust code called:

```nix
builtins.getFlake "git+https://...dotfiles?ref=nixos&rev=..."
```

Under systemd, this caused a `follows + flake reference` error because `builtins.getFlake` tried to re-resolve inputs with no registry or network context.

We tried pinning the flake using `narHash`, but adding it directly to the Git URL made Git reject it (`/info/refs not valid`).
We then switched to `builtins.fetchTree` with `narHash` for purity, but `builtins.getFlake (toString src)` failed because it passed a store path string, which Nix disallows.

The current working hypothesis is that the correct approach is:

```nix
flake = builtins.getFlake "path:${src}";
```

where `src` is the result of `builtins.fetchTree`.
This avoids network resolution, works in pure environments, and ensures reproducible evaluation.

So far:

* We confirmed that interactive shells succeed due to cached or impure flake resolution.
* Systemd + Rust fails because the environment is pure and `getFlake` re-fetches inputs.
* Using `fetchTree` with a pinned `narHash` should fix it; weâ€™re validating that path-based invocation now.

---

In short:
**Root cause:** systemdâ€™s clean environment causes `builtins.getFlake` to re-resolve flakes, which fails without a registry/network.
**Fix:** use `builtins.fetchTree` + `builtins.getFlake "path:${src}"` to pin content and avoid impure resolution.

I will provide more code examples and context dont respond yet just let me give you all the info and you start thinking about how to solve this.


this is the interactive shell that seems to work

[crystal-forge@reckless:~]$ nix run nixpkgs#nix-eval-jobs -- --expr 'let
  flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";
in builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations' \
  --workers 8 --max-memory-size 4096 --check-cache-status --meta
warning: unknown setting 'allowed-users'
warning: unknown setting 'trusted-users'
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: zfs.latestCompatibleLinuxPackages is deprecated and is now pointing at the default kernel. If using the stable LTS kernel (default `linuxPackages` is not possible then you must explicitly pin a specific kernel release. For example, `boot.kernelPackages = pkgs.linuxPackages_6_6`. Please be aware that non-LTS kernels are likely to go EOL before ZFS supports the latest supported non-LTS release, requiring manual intervention.
evaluation warning: zfs.latestCompatibleLinuxPackages is deprecated and is now pointing at the default kernel. If using the stable LTS kernel (default `linuxPackages` is not possible then you must explicitly pin a specific kernel release. For example, `boot.kernelPackages = pkgs.linuxPackages_6_6`. Please be aware that non-LTS kernels are likely to go EOL before ZFS supports the latest supported non-LTS release, requiring manual intervention.
evaluation warning: zfs.latestCompatibleLinuxPackages is deprecated and is now pointing at the default kernel. If using the stable LTS kernel (default `linuxPackages` is not possible then you must explicitly pin a specific kernel release. For example, `boot.kernelPackages = pkgs.linuxPackages_6_6`. Please be aware that non-LTS kernels are likely to go EOL before ZFS supports the latest supported non-LTS release, requiring manual intervention.
evaluation warning: zfs.latestCompatibleLinuxPackages is deprecated and is now pointing at the default kernel. If using the stable LTS kernel (default `linuxPackages` is not possible then you must explicitly pin a specific kernel release. For example, `boot.kernelPackages = pkgs.linuxPackages_6_6`. Please be aware that non-LTS kernels are likely to go EOL before ZFS supports the latest supported non-LTS release, requiring manual intervention.
evaluation warning: In order to support declarative extension configuration,
                    extension installation has been moved from
                    programs.firefox.profiles.<profile>.extensions
                    to
                    programs.firefox.profiles.<profile>.extensions.packages
evaluation warning: In order to support declarative extension configuration,
                    extension installation has been moved from
                    programs.firefox.profiles.<profile>.extensions
                    to
                    programs.firefox.profiles.<profile>.extensions.packages
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: In order to support declarative extension configuration,
                    extension installation has been moved from
                    programs.firefox.profiles.<profile>.extensions
                    to
                    programs.firefox.profiles.<profile>.extensions.packages
evaluation warning: In order to support declarative extension configuration,
                    extension installation has been moved from
                    programs.firefox.profiles.<profile>.extensions
                    to
                    programs.firefox.profiles.<profile>.extensions.packages
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: 'iconUpdateURL' is deprecated, use 'icon = "https://nixos.wiki/favicon.png"' instead
evaluation warning: 'iconUpdateURL' is deprecated, use 'icon = "https://nixos.wiki/favicon.png"' instead
evaluation warning: 'iconUpdateURL' is deprecated, use 'icon = "https://nixos.wiki/favicon.png"' instead
evaluation warning: 'iconUpdateURL' is deprecated, use 'icon = "https://nixos.wiki/favicon.png"' instead
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
evaluation warning: 'iconUpdateURL' is deprecated, use 'icon = "https://nixos.wiki/favicon.png"' instead
evaluation warning: 'iconUpdateURL' is deprecated, use 'icon = "https://nixos.wiki/favicon.png"' instead
evaluation warning: 'iconUpdateURL' is deprecated, use 'icon = "https://nixos.wiki/favicon.png"' instead
evaluation warning: 'iconUpdateURL' is deprecated, use 'icon = "https://nixos.wiki/favicon.png"' instead
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
evaluation warning: The option `services.xserver.libinput.enable' defined in `/nix/store/mm8n456cvwjcmlfa90ibfmahjq2j0vf0-m6p2255lilq2lgh4jny4fzvw2wwxn00q-source/modules/nixos/desktop/cinnamon/default.nix' has been renamed to `services.libinput.enable'.
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
{"attr":"aws-test","attrPath":["aws-test"],"cacheStatus":"notBuilt","drvPath":"/nix/store/80gdv9622d0jcknjgbj4qm8mvi9kb2d2-nixos-system-aws-test-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-aws-test-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-aws-test-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/a2kxrfvjnwa3dys7fsp3hf2jgsjlihgx-nixos-system-aws-test-25.05.20250924.411893e"},"system":"x86_64-linux"}
{"attr":"ermy","attrPath":["ermy"],"cacheStatus":"notBuilt","drvPath":"/nix/store/idp369q7745x4sp504rc1fhx3576nx68-nixos-system-ermy-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-ermy-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-ermy-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/y96min8dnj04yjk10apkdjcnhvs539bj-nixos-system-ermy-25.05.20250924.411893e"},"system":"x86_64-linux"}
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
{"attr":"chesty","attrPath":["chesty"],"cacheStatus":"notBuilt","drvPath":"/nix/store/s9gdjc09zggg237b8l1m5n0cbzq244mg-nixos-system-chesty-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-chesty-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-chesty-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/lpv10cwxd4hlm5id6ljaazqarqiwsii9-nixos-system-chesty-25.05.20250924.411893e"},"system":"x86_64-linux"}
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: zfs.latestCompatibleLinuxPackages is deprecated and is now pointing at the default kernel. If using the stable LTS kernel (default `linuxPackages` is not possible then you must explicitly pin a specific kernel release. For example, `boot.kernelPackages = pkgs.linuxPackages_6_6`. Please be aware that non-LTS kernels are likely to go EOL before ZFS supports the latest supported non-LTS release, requiring manual intervention.
evaluation warning: zfs.latestCompatibleLinuxPackages is deprecated and is now pointing at the default kernel. If using the stable LTS kernel (default `linuxPackages` is not possible then you must explicitly pin a specific kernel release. For example, `boot.kernelPackages = pkgs.linuxPackages_6_6`. Please be aware that non-LTS kernels are likely to go EOL before ZFS supports the latest supported non-LTS release, requiring manual intervention.
evaluation warning: pypiSnapshot date has been removed, as we didn't see a need for it anymore. Please let us now if you do.
{"attr":"lucas","attrPath":["lucas"],"cacheStatus":"notBuilt","drvPath":"/nix/store/9vd51yc608b95dhiizvjdl3gi5qm6kq9-nixos-system-lucas-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-lucas-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-lucas-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/0h4h4cyf6lxk64cbgyfbhcdb8h90n2vf-nixos-system-lucas-25.05.20250924.411893e"},"system":"x86_64-linux"}
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: mkPackageOptionMD is deprecated and will be removed in 25.05; please use mkPackageOption.
evaluation warning: zfs.latestCompatibleLinuxPackages is deprecated and is now pointing at the default kernel. If using the stable LTS kernel (default `linuxPackages` is not possible then you must explicitly pin a specific kernel release. For example, `boot.kernelPackages = pkgs.linuxPackages_6_6`. Please be aware that non-LTS kernels are likely to go EOL before ZFS supports the latest supported non-LTS release, requiring manual intervention.
evaluation warning: In order to support declarative extension configuration,
                    extension installation has been moved from
                    programs.firefox.profiles.<profile>.extensions
                    to
                    programs.firefox.profiles.<profile>.extensions.packages
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
{"attr":"butler","attrPath":["butler"],"cacheStatus":"notBuilt","drvPath":"/nix/store/q1rfyilv546fxp0nimdxw19gfxmsj4zh-nixos-system-butler-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-butler-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-butler-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/jz34dh6mla9jqf1wyly9rd5hz1xspzd0-nixos-system-butler-25.05.20250924.411893e"},"system":"x86_64-linux"}
{"attr":"daly","attrPath":["daly"],"cacheStatus":"notBuilt","drvPath":"/nix/store/1ivp32sgj8xf3v4hxsb1wzkjf0s8rfbj-nixos-system-daly-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-daly-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-daly-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/44k1vq6d2k4nhv2ij654ggh36z68d1k5-nixos-system-daly-25.05.20250924.411893e"},"system":"x86_64-linux"}
{"attr":"glenn","attrPath":["glenn"],"cacheStatus":"notBuilt","drvPath":"/nix/store/2cmgn56cfgwnmh51p5jwrlhb7l8czbkz-nixos-system-glenn-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-glenn-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-glenn-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/11zdz970pqslaqywiaqnd5r42vr6p8yg-nixos-system-glenn-25.05.20250924.411893e"},"system":"x86_64-linux"}
{"attr":"gray","attrPath":["gray"],"cacheStatus":"notBuilt","drvPath":"/nix/store/5wpnf7garl8nfb70mnhxdmxnp8niqcii-nixos-system-gray-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-gray-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-gray-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/sbs9v8sql148wfcki319c5kwszi5rr8v-nixos-system-gray-25.05.20250924.411893e"},"system":"x86_64-linux"}
evaluation warning: 'pds' has been renamed to 'bluesky-pds'
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
evaluation warning: Nixvim (plugins.which-key): The option definition `plugins.which-key.registrations' in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/lsp.nix' has been deprecated in which-key v3; please remove it.
                    You should use `plugins.which-key.settings.spec' instead.

                    Note: the spec format has changed in which-key v3
                    See: https://github.com/folke/which-key.nvim?tab=readme-ov-file#%EF%B8%8F-mappings
evaluation warning: The option `plugins.conform-nvim.formattersByFt' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/python' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/shell' and `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/languages/rust' has been renamed to `plugins.conform-nvim.settings.formatters_by_ft'.
evaluation warning: The option `diagnostics' defined in `/nix/store/82mr6z9vm4xf0jvss6jwrckpyr94hc84-source/config/features/diagnostics.nix' has been renamed to `diagnostic.settings'.
evaluation warning: 'iconUpdateURL' is deprecated, use 'icon = "https://nixos.wiki/favicon.png"' instead
evaluation warning: 'iconUpdateURL' is deprecated, use 'icon = "https://nixos.wiki/favicon.png"' instead
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
evaluation warning: The option `services.mattermost.localDatabaseCreate' defined in `/nix/store/mm8n456cvwjcmlfa90ibfmahjq2j0vf0-m6p2255lilq2lgh4jny4fzvw2wwxn00q-source/modules/nixos/services/mattermost/default.nix' has been renamed to `services.mattermost.database.create'.
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
evaluation warning: 'pdsadmin' has been renamed to 'bluesky-pdsadmin'
evaluation warning: The option `hardware.opengl.enable' defined in `/nix/store/mm8n456cvwjcmlfa90ibfmahjq2j0vf0-m6p2255lilq2lgh4jny4fzvw2wwxn00q-source/modules/nixos/hardware/via/default.nix' has been renamed to `hardware.graphics.enable'.
evaluation warning: substituteAll is deprecated and will be removed in 25.11. Use replaceVars instead.
{"attr":"test-pi","attrPath":["test-pi"],"cacheStatus":"notBuilt","drvPath":"/nix/store/bdxyrgv20591jnmkzq00ddnglx2vd2fa-nixos-system-test-pi-sd-card-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-test-pi-sd-card-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-test-pi-sd-card-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/dbb1k7d5dgd3j6avfhn7h61qhjkhrna5-nixos-system-test-pi-sd-card-25.05.20250924.411893e"},"system":"aarch64-linux"}
{"attr":"mattis","attrPath":["mattis"],"cacheStatus":"notBuilt","drvPath":"/nix/store/vvw3c20s2vi2vxhy0d9l4ja5acbsmbri-nixos-system-mattis-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-mattis-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-mattis-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/zwkaxc0pf5spvfjzsfhml4l6hia5ccgs-nixos-system-mattis-25.05.20250924.411893e"},"system":"x86_64-linux"}
{"attr":"reckless","attrPath":["reckless"],"cacheStatus":"notBuilt","drvPath":"/nix/store/s8h64zd34p6yzgpwndq3pfvg27bx1k0j-nixos-system-reckless-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-reckless-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-reckless-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/c1q31623gyg9c3sc3yd8hgvmm3fzkamb-nixos-system-reckless-25.05.20250924.411893e"},"system":"x86_64-linux"}
{"attr":"webb","attrPath":["webb"],"cacheStatus":"notBuilt","drvPath":"/nix/store/n56vgh6a6kd6734m9y0kps4jmvwpc4a4-nixos-system-webb-25.05.20250924.411893e.drv","isCached":false,"meta":{"available":true,"broken":false,"insecure":false,"maintainers":[],"name":"nixos-system-webb-25.05.20250924.411893e","outputsToInstall":["out"],"position":"/nix/store/ahjyhvd0fllqc2zhjp362dnm6al2190c-source/nixos/modules/system/activation/top-level.nix:64","unfree":false,"unsupported":false},"name":"nixos-system-webb-25.05.20250924.411893e","neededBuilds":[],"neededSubstitutes":[],"outputs":{"out":"/nix/store/8d8sckilfw5d5c1yazlw3zpwfxx865ra-nixos-system-webb-25.05.20250924.411893e"},"system":"x86_64-linux"}


this si the rust code

use crate::deployment::spawn_deployment_policy_manager;
use crate::flake::commits::sync_all_watched_flakes_commits;
use crate::log::log_builder_worker_status;
use crate::models::commits::Commit;
use crate::models::config::{CrystalForgeConfig, FlakeConfig};
use crate::models::derivations::NixEvalJobResult;
use crate::models::derivations::build_agent_target;
use crate::models::flakes::Flake;
use crate::queries::commits::get_commit_distance_from_head;
use crate::queries::commits::increment_commit_list_attempt_count;
use crate::queries::derivations::{
    get_pending_dry_run_derivations, handle_derivation_failure, insert_derivation_with_target,
    mark_derivation_dry_run_in_progress, update_scheduled_at,
};
use crate::queries::flakes::get_all_flakes_from_db;
use anyhow::Result;
use anyhow::bail;
use futures::stream;
use futures::stream::StreamExt;
use std::process::Stdio;
use tokio::io::AsyncBufReadExt;
use tokio::io::BufReader;
use tokio::process::Command;
use tokio::time::interval;

use sqlx::PgPool;
use tokio::time::Duration;
use tracing::{debug, error, info, warn};

use crate::flake::eval::list_nixos_configurations_from_commit;
use crate::queries::commits::get_commits_pending_evaluation;

pub fn spawn_background_tasks(cfg: CrystalForgeConfig, pool: PgPool) {
    let flake_pool = pool.clone();
    let commit_pool = pool.clone();
    let target_pool = pool.clone();
    let deployment_pool = pool.clone();

    // Get the flake config with a fallback
    let flake_config = cfg.flakes.clone();

    tokio::spawn(run_flake_polling_loop(flake_pool, flake_config.clone()));
    tokio::spawn(run_commit_evaluation_loop(
        commit_pool,
        flake_config.commit_evaluation_interval,
    ));
    // tokio::spawn(run_derivation_evaluation_loop(
    //     target_pool,
    //     flake_config.build_processing_interval,
    // ));

    tokio::spawn(spawn_deployment_policy_manager(cfg, deployment_pool));
}

/// Runs the periodic flake polling loop to check for new commits
async fn run_flake_polling_loop(pool: PgPool, flake_config: FlakeConfig) {
    info!("ðŸ”„ Starting periodic flake polling loop...");
    loop {
        // Get all flakes from database instead of just config ones
        match get_all_flakes_from_db(&pool, &flake_config).await {
            Ok(db_flakes) => {
                if let Err(e) = sync_all_watched_flakes_commits(&pool, &db_flakes).await {
                    error!("âŒ Error in flake polling cycle: {e}");
                }
            }
            Err(e) => error!("âŒ Failed to get flakes from database: {e}"),
        }
        tokio::time::sleep(flake_config.flake_polling_interval).await;
    }
}

/// Runs the periodic commit evaluation check loop
async fn run_commit_evaluation_loop(pool: PgPool, interval: Duration) {
    info!(
        "ðŸ” Starting periodic commit evaluation check loop (every {:?})...",
        interval
    );
    loop {
        if let Err(e) = process_pending_commits(&pool).await {
            error!("âŒ Error in commit evaluation cycle: {e}");
        }
        tokio::time::sleep(interval).await;
    }
}

// Runs the periodic evaluation target resolution loop
// async fn run_derivation_evaluation_loop(pool: PgPool, interval: Duration) {
//     info!(
//         "ðŸ” Starting periodic evaluation target check loop (every {:?})...",
//         interval
//     );
//     loop {
//         if let Err(e) = process_pending_derivations(&pool).await {
//             error!("âŒ Error in target evaluation cycle: {e}");
//         }
//         tokio::time::sleep(interval).await;
//     }
// }

async fn process_pending_commits(pool: &PgPool) -> Result<()> {
    match get_commits_pending_evaluation(&pool).await {
        Ok(pending_commits) => {
            info!("ðŸ“Œ Found {} pending commits", pending_commits.len());
            for commit in pending_commits {
                // Get flake info
                let flake = match commit.get_flake(&pool).await {
                    Ok(flake) => flake,
                    Err(e) => {
                        error!(
                            "âŒ Failed to get flake for commit {}: {}",
                            commit.git_commit_hash, e
                        );
                        continue;
                    }
                };

                // Use nix-eval-jobs to discover AND evaluate all nixosConfigurations in one pass
                match evaluate_and_discover_nixos_configs(pool, &commit, &flake).await {
                    Ok(count) => {
                        info!(
                            "âœ… Evaluated and inserted {} NixOS configurations for commit {}",
                            count, commit.git_commit_hash
                        );
                    }
                    Err(e) => {
                        error!(
                            "âŒ Failed to evaluate commit {}: {}",
                            commit.git_commit_hash, e
                        );
                        // Increment attempt count so we don't retry forever
                        if let Err(inc_err) =
                            increment_commit_list_attempt_count(&pool, &commit).await
                        {
                            error!("âŒ Failed to increment attempt count: {}", inc_err);
                        }
                    }
                }
            }
        }
        Err(e) => error!("âŒ Failed to get pending commits: {e}"),
    }
    Ok(())
}

// async fn process_pending_derivations(pool: &PgPool) -> Result<()> {
//     update_scheduled_at(pool).await?;
//
//     let cfg = CrystalForgeConfig::load().unwrap_or_else(|e| {
//         warn!("Failed to load Crystal Forge config: {}, using defaults", e);
//         CrystalForgeConfig::default()
//     });
//     let build_config = cfg.get_build_config();
//
//     match get_pending_dry_run_derivations(pool).await {
//         Ok(pending_targets) => {
//             info!("ðŸ“¦ Found {} pending targets", pending_targets.len());
//
//             let concurrency_limit = 5;
//
//             // Initialize worker status
//             let dry_run_status = crate::log::get_dry_run_status();
//             {
//                 let mut status = dry_run_status.write().await;
//                 status.clear();
//                 for i in 0..concurrency_limit {
//                     status.push(crate::log::WorkerStatus {
//                         worker_id: i,
//                         current_task: None,
//                         started_at: None,
//                         state: crate::log::WorkerState::Idle,
//                     });
//                 }
//             }
//
//             stream::iter(
//                 pending_targets
//                     .into_iter()
//                     .enumerate()
//                     .map(|(idx, mut target)| {
//                         let pool = pool.clone();
//                         let build_config = build_config.clone();
//                         let worker_id = idx % concurrency_limit;
//
//                         async move {
//                             // Get commit info for this derivation
//                             let task_description = if let Some(commit_id) = target.commit_id {
//                                 match crate::queries::commits::get_commit_by_id(&pool, commit_id)
//                                     .await
//                                 {
//                                     Ok(commit) => {
//                                         // Get distance from HEAD if possible
//                                         let distance_info = match commit.get_flake(&pool).await {
//                                             Ok(flake) => {
//                                                 match get_commit_distance_from_head(
//                                                     &pool, &flake, &commit,
//                                                 )
//                                                 .await
//                                                 {
//                                                     Ok(distance) => format!(" (HEAD~{})", distance),
//                                                     Err(_) => String::new(),
//                                                 }
//                                             }
//                                             Err(_) => String::new(),
//                                         };
//
//                                         format!(
//                                             "{} @ {}{}",
//                                             target.derivation_name,
//                                             &commit.git_commit_hash[..8],
//                                             distance_info
//                                         )
//                                     }
//                                     Err(_) => {
//                                         format!("{} @ commit#{}", target.derivation_name, commit_id)
//                                     }
//                                 }
//                             } else {
//                                 target.derivation_name.clone()
//                             };
//
//                             // Mark worker as working
//                             {
//                                 let mut status = dry_run_status.write().await;
//                                 if let Some(worker) = status.get_mut(worker_id) {
//                                     worker.state = crate::log::WorkerState::Working;
//                                     worker.current_task = Some(task_description.clone());
//                                     worker.started_at = Some(std::time::Instant::now());
//                                 }
//                             }
//
//                             if let Err(e) =
//                                 mark_derivation_dry_run_in_progress(&pool, target.id).await
//                             {
//                                 error!("âŒ Failed to mark target in-progress: {e}");
//                                 // Mark worker as idle
//                                 let mut status = dry_run_status.write().await;
//                                 if let Some(worker) = status.get_mut(worker_id) {
//                                     worker.state = crate::log::WorkerState::Idle;
//                                     worker.current_task = None;
//                                     worker.started_at = None;
//                                 }
//                                 return;
//                             }
//
//                             let start = std::time::Instant::now();
//                             match target.evaluate_and_build(&pool, false, &build_config).await {
//                                 Ok(_derivation_path) => {
//                                     let duration = start.elapsed();
//                                     info!(
//                                         "âœ… Completed dry-run for {} in {:.2}s",
//                                         task_description,
//                                         duration.as_secs_f64()
//                                     );
//                                 }
//                                 Err(e) => {
//                                     error!("âŒ Failed dry-run for {}: {}", task_description, e);
//                                     if let Err(handle_err) =
//                                         handle_derivation_failure(&pool, &target, "dry-run", &e)
//                                             .await
//                                     {
//                                         error!(
//                                             "âŒ Failed to handle derivation failure: {handle_err}"
//                                         );
//                                     }
//                                 }
//                             }
//
//                             // Mark worker as idle
//                             let mut status = dry_run_status.write().await;
//                             if let Some(worker) = status.get_mut(worker_id) {
//                                 worker.state = crate::log::WorkerState::Idle;
//                                 worker.current_task = None;
//                                 worker.started_at = None;
//                             }
//                         }
//                     }),
//             )
//             .for_each_concurrent(concurrency_limit, |fut| fut)
//             .await;
//         }
//         Err(e) => error!("âŒ Failed to get pending targets: {e}"),
//     }
//     Ok(())
// }

pub async fn memory_monitor_task(pool: PgPool) {
    let mut interval = interval(Duration::from_secs(30));
    loop {
        interval.tick().await;
        log_memory_usage(&pool).await;
    }
}

async fn log_memory_usage(pool: &PgPool) {
    // Memory stats from /proc/self/status
    if let Ok(contents) = tokio::fs::read_to_string("/proc/self/status").await {
        let mut vm_rss = None;
        let mut vm_size = None;
        let mut vm_peak = None;

        for line in contents.lines() {
            if line.starts_with("VmRSS:") {
                vm_rss = line.split_whitespace().nth(1);
            } else if line.starts_with("VmSize:") {
                vm_size = line.split_whitespace().nth(1);
            } else if line.starts_with("VmPeak:") {
                vm_peak = line.split_whitespace().nth(1);
            }
        }

        debug!(
            "ðŸ“Š Memory - RSS: {} kB, Size: {} kB, Peak: {} kB",
            vm_rss.unwrap_or("?"),
            vm_size.unwrap_or("?"),
            vm_peak.unwrap_or("?")
        );
    }

    // Database pool statistics
    let pool_size = pool.size() as usize;
    let idle_count = pool.num_idle();

    debug!(
        "ðŸ“Š DB Pool - Total: {}, Idle: {}, Active: {}",
        pool_size,
        idle_count,
        pool_size - idle_count
    );

    log_builder_worker_status().await;
    // Task/thread count
    if let Ok(contents) = tokio::fs::read_to_string("/proc/self/stat").await {
        if let Some(num_threads) = contents.split_whitespace().nth(19) {
            debug!("ðŸ“Š Threads: {}", num_threads);
        }
    }
}

/// Use nix-eval-jobs to discover AND evaluate all nixosConfigurations in one parallel pass
pub async fn evaluate_and_discover_nixos_configs(
    pool: &PgPool,
    commit: &Commit,
    flake: &Flake,
) -> Result<usize> {
    info!(
        "ðŸš€ Evaluating all nixosConfigurations for commit {} with nix run nixpkgs#nix-eval-jobs",
        commit.git_commit_hash
    );

    let flake_ref = build_flake_reference(&flake.repo_url, &commit.git_commit_hash);
    let workers = 8usize;
    let max_mem_mb = 4096usize;

    // Clean and correct Nix expression
    let nix_expr = format!(
        r#"
        let
          flake = builtins.getFlake "{flake_ref}";
        in
          builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations
        "#
    )
    .trim_end_matches('"')
    .to_string();

    let mut cmd = Command::new("nix-eval-jobs");
    cmd.env("HOME", "/var/lib/crystal-forge");
    cmd.env("XDG_CONFIG_HOME", "/var/lib/crystal-forge/.config");
    cmd.env("NIX_CONF_DIR", "/dev/null");
    cmd.env("NIX_USER_CONF_FILES", "/dev/null");
    cmd.env("NIX_REGISTRY", "/dev/null");
    cmd.env(
        "NIX_CONFIG",
        "experimental-features = nix-command flakes\nflake-registry =\n",
    );

    cmd.args([
        "--expr",
        &nix_expr,
        "--workers",
        &workers.to_string(),
        "--max-memory-size",
        &max_mem_mb.to_string(),
        "--check-cache-status",
        "--meta",
        "--show-trace",
    ])
    .stdout(Stdio::piped())
    .stderr(Stdio::piped());

    // âœ… Log the exact command and environment before running
    let env_preview = [
        ("HOME", "/var/lib/crystal-forge"),
        ("XDG_CONFIG_HOME", "/var/lib/crystal-forge/.config"),
        ("NIX_CONF_DIR", "/dev/null"),
        ("NIX_USER_CONF_FILES", "/dev/null"),
        ("NIX_REGISTRY", "/dev/null"),
        (
            "NIX_CONFIG",
            "experimental-features = nix-command flakes\nflake-registry =\n",
        ),
    ];
    let cmd_str = format!(
        "nix-eval-jobs -- --expr '{}' --workers {} --max-memory-size {} --check-cache-status --meta",
        nix_expr.replace('\n', " "),
        workers,
        max_mem_mb
    );
    debug!(
        "ðŸ’» Executing command:\n{}\nEnvironment:\n{:#?}",
        cmd_str, env_preview
    );

    let mut child = cmd.spawn()?;
    let stdout = child.stdout.take().unwrap();
    let stderr = child.stderr.take().unwrap();

    let mut stdout_reader = BufReader::new(stdout).lines();
    let mut stderr_reader = BufReader::new(stderr).lines();

    let mut eval_results = Vec::<NixEvalJobResult>::new();
    let mut stderr_output = Vec::<String>::new();
    let (mut stdout_done, mut stderr_done) = (false, false);

    loop {
        tokio::select! {
            line = stdout_reader.next_line(), if !stdout_done => {
                match line? {
                    Some(line) if !line.trim().is_empty() => {
                        match serde_json::from_str::<NixEvalJobResult>(&line) {
                            Ok(result) => {
                                debug!("ðŸ“¦ Evaluated: attr={:?}, cache={:?}", result.attr_path, result.cache_status);
                                eval_results.push(result);
                            }
                            Err(e) => warn!("Failed to parse nix-eval-jobs json line: {e}\nLine: {line}"),
                        }
                    }
                    Some(_) => {}
                    None => stdout_done = true,
                }
            }
            line = stderr_reader.next_line(), if !stderr_done => {
                match line? {
                    Some(line) => {
                        if line.contains("error:") {
                            error!("nix-eval-jobs: {line}");
                        } else if !line.starts_with("warning:") {
                            debug!("nix-eval-jobs: {line}");
                        }
                        stderr_output.push(line);
                    }
                    None => stderr_done = true,
                }
            }
        }
        if stdout_done && stderr_done {
            break;
        }
    }

    let status = child.wait().await?;

    // âœ… Log full command + captured stderr if it fails
    if !status.success() {
        let stderr_text = stderr_output.join("\n");
        error!(
            "âŒ nix-eval-jobs failed (exit code {})\n\
             Command:\n{}\n\
             Environment:\n{:#?}\n\
             Stderr:\n{}",
            status.code().unwrap_or(-1),
            cmd_str,
            env_preview,
            stderr_text
        );
        bail!(
            "nix-eval-jobs failed with exit code: {}\nSee logs above for details.",
            status.code().unwrap_or(-1)
        );
    }

    let status = child.wait().await?;
    if !status.success() {
        let stderr_text = stderr_output.join("\n");
        bail!(
            "nix-eval-jobs failed with exit code: {}\nStderr:\n{}",
            status.code().unwrap_or(-1),
            stderr_text
        );
    }

    if eval_results.is_empty() {
        warn!("No nixosConfigurations found in {}", flake_ref);
        return Ok(0);
    }

    info!("âœ… Evaluated {} nixosConfigurations", eval_results.len());

    // Insert/update results exactly like before
    let mut inserted_count = 0usize;
    for result in eval_results {
        let system_name = match result.attr_path.first() {
            Some(name) => name.as_str(),
            None => {
                warn!(
                    "Could not extract system name from attrPath: {:?}",
                    result.attr_path
                );
                continue;
            }
        };

        // If evaluation failed for this attr, record the failure
        if let Some(error_msg) = &result.error {
            error!("âŒ Evaluation failed for {}: {}", system_name, error_msg);

            let derivation_target =
                build_agent_target(&flake.repo_url, &commit.git_commit_hash, system_name);

            match insert_derivation_with_target(
                pool,
                Some(commit),
                system_name,
                "nixos",
                Some(&derivation_target),
            )
            .await
            {
                Ok(deriv) => {
                    let _ = crate::queries::derivations::update_derivation_status(
                        pool,
                        deriv.id,
                        crate::queries::derivations::EvaluationStatus::DryRunFailed,
                        None,
                        Some(error_msg),
                        None,
                    )
                    .await;
                }
                Err(e) => error!("Failed to insert failed derivation {}: {}", system_name, e),
            }
            continue;
        }

        let drv_path = match &result.drv_path {
            Some(p) => p.as_str(),
            None => {
                warn!("No derivation path for {}", system_name);
                continue;
            }
        };

        let store_path = result
            .outputs
            .as_ref()
            .and_then(|o| o.get("out"))
            .map(|s| s.as_str());

        let derivation_target =
            build_agent_target(&flake.repo_url, &commit.git_commit_hash, system_name);

        match insert_derivation_with_target(
            pool,
            Some(commit),
            system_name,
            "nixos",
            Some(&derivation_target),
        )
        .await
        {
            Ok(deriv) => {
                info!(
                    "âœ… Inserted NixOS derivation: {} (commit {}) -> {}",
                    system_name, commit.git_commit_hash, derivation_target
                );

                let _ = crate::queries::derivations::update_derivation_status(
                    pool,
                    deriv.id,
                    crate::queries::derivations::EvaluationStatus::DryRunComplete,
                    Some(drv_path),
                    None,
                    store_path,
                )
                .await;

                if result.cache_status.as_deref() == Some("local") {
                    if let Some(sp) = store_path {
                        info!("ðŸ’¾ {} is already built locally", system_name);
                        let _ = crate::queries::derivations::mark_derivation_build_complete(
                            pool, deriv.id, sp,
                        )
                        .await;
                    }
                }

                inserted_count += 1;
            }
            Err(e) => {
                error!(
                    "âŒ Failed to insert NixOS derivation for {}: {}",
                    system_name, e
                );
            }
        }
    }

    Ok(inserted_count)
}

/// Build the base flake reference (git+url?rev=hash)
fn build_flake_reference(repo_url: &str, commit_hash: &str) -> String {
    if repo_url.starts_with("git+") {
        if repo_url.contains("?rev=") {
            repo_url.to_string()
        } else {
            format!("{}?rev={}", repo_url, commit_hash)
        }
    } else {
        let separator = if repo_url.contains('?') { "&" } else { "?" };
        format!("git+{}{separator}rev={}", repo_url, commit_hash)
    }
}

this is the journalctl from where it fails

Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: 2025-10-21T01:01:23.668814Z DEBUG crystal_forge::server: nix-eval-jobs:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: 2025-10-21T01:01:23.668816Z DEBUG crystal_forge::server: nix-eval-jobs:               â€¦ while updating the flake input 'campground-packages'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: 2025-10-21T01:01:23.668818Z DEBUG crystal_forge::server: nix-eval-jobs:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: 2025-10-21T01:01:23.668820Z ERROR crystal_forge::server: nix-eval-jobs:               error: flake input has both a flake reference and a follows attribute, at Â«gitlab:usmcamp0811/campground-packages/564e2a1c8eadee03a279f003fdfe50d9db8779f5?narHash=sha256-ivi1Xa/3kIHVgM/9wgeZmYyTLyGu4d/1Zn%2BvCCUNC6E%3DÂ»/nix/store/67l701bagpi031sh8r0qn53xxnv8pi0z-source/flake.nix:6:5
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: 2025-10-21T01:01:23.676520Z ERROR crystal_forge::server: âŒ nix-eval-jobs failed (exit code 1)
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: Command:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: nix-eval-jobs -- --expr '         let           flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";         in           builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations         ' --workers 8 --max-memory-size 4096 --check-cache-status --meta
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: Environment:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: [
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     (
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "HOME",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "/var/lib/crystal-forge",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     ),
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     (
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "XDG_CONFIG_HOME",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "/var/lib/crystal-forge/.config",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     ),
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     (
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "NIX_CONF_DIR",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "/dev/null",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     ),
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     (
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "NIX_USER_CONF_FILES",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "/dev/null",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     ),
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     (
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "NIX_REGISTRY",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "/dev/null",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     ),
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     (
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "NIX_CONFIG",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:         "experimental-features = nix-command flakes\nflake-registry =\n",
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:     ),
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: ]
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: Stderr:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: error:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'mapAttrs' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:5:11:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             5|           builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |           ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             6|
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'getFlake' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:3:19:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             2|         let
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             3|           flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |                   ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the lock file of flake 'git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the flake input 'campground-packages'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        error: flake input has both a flake reference and a follows attribute, at Â«gitlab:usmcamp0811/campground-packages/564e2a1c8eadee03a279f003fdfe50d9db8779f5?narHash=sha256-ivi1Xa/3kIHVgM/9wgeZmYyTLyGu4d/1Zn%2BvCCUNC6E%3DÂ»/nix/store/67l701bagpi031sh8r0qn53xxnv8pi0z-source/flake.nix:6:5
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: error:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'mapAttrs' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:5:11:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             5|           builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |           ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             6|
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'getFlake' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:3:19:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             2|         let
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             3|           flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |                   ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the lock file of flake 'git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the flake input 'campground-packages'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        error: flake input has both a flake reference and a follows attribute, at Â«gitlab:usmcamp0811/campground-packages/564e2a1c8eadee03a279f003fdfe50d9db8779f5?narHash=sha256-ivi1Xa/3kIHVgM/9wgeZmYyTLyGu4d/1Zn%2BvCCUNC6E%3DÂ»/nix/store/67l701bagpi031sh8r0qn53xxnv8pi0z-source/flake.nix:6:5
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: error:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'mapAttrs' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:5:11:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             5|           builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |           ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             6|
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'getFlake' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:3:19:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             2|         let
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             3|           flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |                   ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the lock file of flake 'git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the flake input 'campground-packages'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        error: flake input has both a flake reference and a follows attribute, at Â«gitlab:usmcamp0811/campground-packages/564e2a1c8eadee03a279f003fdfe50d9db8779f5?narHash=sha256-ivi1Xa/3kIHVgM/9wgeZmYyTLyGu4d/1Zn%2BvCCUNC6E%3DÂ»/nix/store/67l701bagpi031sh8r0qn53xxnv8pi0z-source/flake.nix:6:5
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: error:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'mapAttrs' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:5:11:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             5|           builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |           ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             6|
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'getFlake' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:3:19:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             2|         let
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             3|           flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |                   ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the lock file of flake 'git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the flake input 'campground-packages'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        error: flake input has both a flake reference and a follows attribute, at Â«gitlab:usmcamp0811/campground-packages/564e2a1c8eadee03a279f003fdfe50d9db8779f5?narHash=sha256-ivi1Xa/3kIHVgM/9wgeZmYyTLyGu4d/1Zn%2BvCCUNC6E%3DÂ»/nix/store/67l701bagpi031sh8r0qn53xxnv8pi0z-source/flake.nix:6:5
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: error:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'mapAttrs' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:5:11:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             5|           builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |           ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             6|
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'getFlake' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:3:19:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             2|         let
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             3|           flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |                   ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the lock file of flake 'git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the flake input 'campground-packages'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        error: flake input has both a flake reference and a follows attribute, at Â«gitlab:usmcamp0811/campground-packages/564e2a1c8eadee03a279f003fdfe50d9db8779f5?narHash=sha256-ivi1Xa/3kIHVgM/9wgeZmYyTLyGu4d/1Zn%2BvCCUNC6E%3DÂ»/nix/store/67l701bagpi031sh8r0qn53xxnv8pi0z-source/flake.nix:6:5
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: error:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'mapAttrs' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:5:11:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             5|           builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |           ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             6|
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'getFlake' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:3:19:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             2|         let
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             3|           flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |                   ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the lock file of flake 'git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the flake input 'campground-packages'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        error: flake input has both a flake reference and a follows attribute, at Â«gitlab:usmcamp0811/campground-packages/564e2a1c8eadee03a279f003fdfe50d9db8779f5?narHash=sha256-ivi1Xa/3kIHVgM/9wgeZmYyTLyGu4d/1Zn%2BvCCUNC6E%3DÂ»/nix/store/67l701bagpi031sh8r0qn53xxnv8pi0z-source/flake.nix:6:5
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: error:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'mapAttrs' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:5:11:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             5|           builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |           ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             6|
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'getFlake' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:3:19:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             2|         let
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             3|           flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |                   ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the lock file of flake 'git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the flake input 'campground-packages'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        error: flake input has both a flake reference and a follows attribute, at Â«gitlab:usmcamp0811/campground-packages/564e2a1c8eadee03a279f003fdfe50d9db8779f5?narHash=sha256-ivi1Xa/3kIHVgM/9wgeZmYyTLyGu4d/1Zn%2BvCCUNC6E%3DÂ»/nix/store/67l701bagpi031sh8r0qn53xxnv8pi0z-source/flake.nix:6:5
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: error:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'mapAttrs' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:5:11:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             5|           builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |           ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             6|
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while calling the 'getFlake' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:          at Â«stringÂ»:3:19:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             2|         let
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             3|           flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:              |                   ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:             4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the lock file of flake 'git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        â€¦ while updating the flake input 'campground-packages'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:        error: flake input has both a flake reference and a follows attribute, at Â«gitlab:usmcamp0811/campground-packages/564e2a1c8eadee03a279f003fdfe50d9db8779f5?narHash=sha256-ivi1Xa/3kIHVgM/9wgeZmYyTLyGu4d/1Zn%2BvCCUNC6E%3DÂ»/nix/store/67l701bagpi031sh8r0qn53xxnv8pi0z-source/flake.nix:6:5
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: error: worker error: error:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:               â€¦ while calling the 'mapAttrs' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:                 at Â«stringÂ»:5:11:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:                    4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:                    5|           builtins.mapAttrs (_: cfg: cfg.config.system.build.toplevel) flake.nixosConfigurations
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:                     |           ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:                    6|
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:               â€¦ while calling the 'getFlake' builtin
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:                 at Â«stringÂ»:3:19:
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:                    2|         let
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:                    3|           flake = builtins.getFlake "git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6";
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:                     |                   ^
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:                    4|         in
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:               â€¦ while updating the lock file of flake 'git+https://gitlab.com/usmcamp0811/dotfiles?ref=nixos&rev=e45b932000d4d79d5d4d985380d83befb9423dc6'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:               â€¦ while updating the flake input 'campground-packages'
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]:               error: flake input has both a flake reference and a follows attribute, at Â«gitlab:usmcamp0811/campground-packages/564e2a1c8eadee03a279f003fdfe50d9db8779f5?narHash=sha256-ivi1Xa/3kIHVgM/9wgeZmYyTLyGu4d/1Zn%2BvCCUNC6E%3DÂ»/nix/store/67l701bagpi031sh8r0qn53xxnv8pi0z-source/flake.nix:6:5
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: 2025-10-21T01:01:23.676550Z ERROR crystal_forge::server: âŒ Failed to evaluate commit e45b932000d4d79d5d4d985380d83befb9423dc6: nix-eval-jobs failed with exit code: 1
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: See logs above for details.
Oct 20 20:01:23 reckless 2y7vabq4m1rjyf9sabjpy4j2z8fmby8y-crystal-forge-server[2511455]: 2025-10-21T01:01:23.676931Z DEBUG sqlx::query: summary="UPDATE commits SET attempt_count â€¦" db.statement="\n\n\n        UPDATE commits\n        SET attempt_count = attempt_count + 1\n        WHERE id = $1\n        \n" rows_affected=1 rows_returned=0 elapsed=296.029Âµs elapsed_secs=0.000296029


this is the nixos module 

{
  config,
  lib,
  pkgs,
  ...
}: let
  cfg = config.services.crystal-forge;
  tomlFormat = pkgs.formats.toml {};
  postgres_pkg = config.services.postgresql.package;

  # Recursively remove any null values so TOML generation wonâ€™t choke.
  stripNulls = v:
    if builtins.isAttrs v
    then lib.filterAttrs (_: vv: vv != null) (lib.mapAttrs (_: stripNulls) v)
    else if builtins.isList v
    then lib.filter (x: x != null) (map stripNulls v)
    else v;

  # Build the raw config first (your existing baseConfig logic, unchanged)
  baseConfigRaw =
    {
      database = {
        host = cfg.database.host;
        port = cfg.database.port;
        user = cfg.database.user;
        password =
          if cfg.database.passwordFile != null
          then "__PLACEHOLDER_PASSWORD__"
          else cfg.database.password;
        name = cfg.database.name;
      };
    }
    // lib.optionalAttrs cfg.server.enable {
      server = {
        host = cfg.server.host;
        port = cfg.server.port;
      };
    }
    // lib.optionalAttrs cfg.client.enable {
      client = {
        server_host = cfg.client.server_host;
        server_port = cfg.client.server_port;
        private_key = toString cfg.client.private_key;
      };
    }
    // lib.optionalAttrs (cfg.deployment.cache_url != null || cfg.deployment.max_deployment_age_minutes != 30 || !cfg.deployment.dry_run_first || cfg.deployment.fallback_to_local_build || cfg.deployment.deployment_timeout_minutes != 60 || cfg.deployment.deployment_poll_interval != "15m") {
      deployment =
        {
          max_deployment_age_minutes = cfg.deployment.max_deployment_age_minutes;
          dry_run_first = cfg.deployment.dry_run_first;
          fallback_to_local_build = cfg.deployment.fallback_to_local_build;
          deployment_timeout_minutes = cfg.deployment.deployment_timeout_minutes;
          deployment_poll_interval = cfg.deployment.deployment_poll_interval;
        }
        // lib.optionalAttrs (cfg.deployment.cache_url != null) {
          cache_url = cfg.deployment.cache_url;
          cache_public_key = cfg.deployment.cache_public_key;
        };
    }
    // lib.optionalAttrs (cfg.systems != []) {
      # NOTE: systemsâ€™ items can include null fields by default (e.g., flake_name, desired_target, server_public_key)
      # Weâ€™ll strip them globally via stripNulls below.
      systems = cfg.systems;
    }
    // lib.optionalAttrs (cfg.flakes.watched != []) {
      flakes = {
        watched = cfg.flakes.watched;
        flake_polling_interval = cfg.flakes.flake_polling_interval;
        commit_evaluation_interval = cfg.flakes.commit_evaluation_interval;
        build_processing_interval = cfg.flakes.build_processing_interval;
      };
    }
    // lib.optionalAttrs (cfg.environments != []) {
      environments = cfg.environments;
    }
    // lib.optionalAttrs cfg.build.enable {
      build =
        {
          cores = cfg.build.cores;
          max_jobs = cfg.build.max_jobs;
          use_substitutes = cfg.build.use_substitutes;
          offline = cfg.build.offline;
          poll_interval = cfg.build.poll_interval;
          max_silent_time = cfg.build.max_silent_time;
          timeout = cfg.build.timeout;
          sandbox = cfg.build.sandbox;
          use_systemd_scope = cfg.build.use_systemd_scope;
          max_concurrent_derivations = cfg.build.max_concurrent_derivations;
        }
        // lib.optionalAttrs (cfg.build.systemd_memory_max != null) {
          systemd_memory_max = cfg.build.systemd_memory_max;
        }
        // lib.optionalAttrs (cfg.build.systemd_cpu_quota != null) {
          systemd_cpu_quota = cfg.build.systemd_cpu_quota;
        }
        // lib.optionalAttrs (cfg.build.systemd_timeout_stop_sec != null) {
          systemd_timeout_stop_sec = cfg.build.systemd_timeout_stop_sec;
        }
        // lib.optionalAttrs (cfg.build.systemd_properties != []) {
          systemd_properties = cfg.build.systemd_properties;
        };
    }
    // lib.optionalAttrs (cfg.auth.ssh_key_path != null || cfg.auth.netrc_path != null || cfg.auth.ssh_known_hosts_path != null || cfg.auth.ssh_disable_strict_host_checking) {
      auth =
        lib.optionalAttrs (cfg.auth.ssh_key_path != null) {
          ssh_key_path = toString cfg.auth.ssh_key_path;
        }
        // lib.optionalAttrs (cfg.auth.ssh_known_hosts_path != null) {
          ssh_known_hosts_path = toString cfg.auth.ssh_known_hosts_path;
        }
        // lib.optionalAttrs (cfg.auth.netrc_path != null) {
          netrc_path = toString cfg.auth.netrc_path;
        }
        // lib.optionalAttrs cfg.auth.ssh_disable_strict_host_checking {
          ssh_disable_strict_host_checking = cfg.auth.ssh_disable_strict_host_checking;
        };
    }
    // {
      vulnix =
        {
          timeout = cfg.vulnix.timeout;
          max_retries = cfg.vulnix.max_retries;
          enable_whitelist = cfg.vulnix.enable_whitelist;
          extra_args = cfg.vulnix.extra_args;
          poll_interval = cfg.vulnix.poll_interval;
        }
        // lib.optionalAttrs (cfg.vulnix.whitelist_path != null) {
          whitelist_path = toString cfg.vulnix.whitelist_path;
        };
    }
    // lib.optionalAttrs (cfg.cache.push_to != null || cfg.cache.cache_type != "Nix") {
      cache =
        {
          cache_type = cfg.cache.cache_type;
          push_after_build = cfg.cache.push_after_build;
          parallel_uploads = cfg.cache.parallel_uploads;
          max_retries = cfg.cache.max_retries;
          retry_delay_seconds = cfg.cache.retry_delay_seconds;
        }
        // lib.optionalAttrs (cfg.cache.push_to != null) {
          push_to = cfg.cache.push_to;
        }
        // lib.optionalAttrs (cfg.cache.signing_key != null) {
          signing_key = toString cfg.cache.signing_key;
        }
        // lib.optionalAttrs (cfg.cache.compression != null) {
          compression = cfg.cache.compression;
        }
        // lib.optionalAttrs (cfg.cache.push_filter != null) {
          push_filter = cfg.cache.push_filter;
        }
        // lib.optionalAttrs (cfg.cache.s3_region != null) {
          s3_region = cfg.cache.s3_region;
        }
        // lib.optionalAttrs (cfg.cache.s3_profile != null) {
          s3_profile = cfg.cache.s3_profile;
        }
        // lib.optionalAttrs (cfg.cache.attic_token != null) {
          attic_token = cfg.cache.attic_token;
        }
        // lib.optionalAttrs (cfg.cache.attic_cache_name != null) {
          attic_cache_name = cfg.cache.attic_cache_name;
        };
    };

  # Now sanitize away any nulls before TOML generation
  baseConfig = stripNulls baseConfigRaw;

  rawConfigFile = tomlFormat.generate "crystal-forge-config.toml" baseConfig;
  generatedConfigPath = "/var/lib/crystal-forge/config.toml";

  configScript = pkgs.writeShellScript "generate-crystal-forge-config" ''
    set -euo pipefail
    mkdir -p "$(dirname "${generatedConfigPath}")"
    cp "${rawConfigFile}" "${generatedConfigPath}"

    ${lib.optionalString (cfg.database.passwordFile != null) ''
      if [ -f "${cfg.database.passwordFile}" ]; then
        PASSWORD=$(cat "${cfg.database.passwordFile}")
        ${pkgs.gnused}/bin/sed -i "s|__PLACEHOLDER_PASSWORD__|$PASSWORD|" "${generatedConfigPath}"
      else
        echo "ERROR: Password file not found: ${cfg.database.passwordFile}" >&2
        exit 1
      fi
    ''}

    ${lib.optionalString (cfg.cache.cache_type == "Attic") ''
      if [ -f "${cfg.env-file}" ]; then
        echo "Loading Attic token from ${cfg.env-file}..."
        source ${cfg.env-file}
        if [ -n "$ATTIC_TOKEN" ]; then
          echo "Injecting dynamic ATTIC_TOKEN into config..."
          if grep -q "attic_token" "${generatedConfigPath}"; then
            ${pkgs.gnused}/bin/sed -i "s|attic_token = .*|attic_token = \"$ATTIC_TOKEN\"|" "${generatedConfigPath}"
          else
            ${pkgs.gnused}/bin/sed -i '/^\[cache\]/a attic_token = "'"$ATTIC_TOKEN"'"' "${generatedConfigPath}"
          fi
          echo "âœ… Attic token injected successfully"
        else
          echo "âš ï¸  ATTIC_TOKEN not found in ${cfg.env-file}"
        fi
      else
        echo "âš ï¸  ${cfg.env-file} not found - using static attic_token from config"
      fi
    ''}

    ${lib.optionalString (cfg.auth.ssh_key_path == null && (cfg.build.enable || cfg.server.enable)) ''
      SSH_KEY_PATH="/var/lib/crystal-forge/.ssh/id_ed25519"
      if [ ! -f "$SSH_KEY_PATH" ]; then
        echo "Generating SSH key for Crystal Forge Git authentication..."
        ${pkgs.openssh}/bin/ssh-keygen -t ed25519 -f "$SSH_KEY_PATH" -N "" -C "crystal-forge@$(${pkgs.nettools}/bin/hostname)"
        chown crystal-forge:crystal-forge "$SSH_KEY_PATH" "$SSH_KEY_PATH.pub"
        chmod 600 "$SSH_KEY_PATH"
        chmod 644 "$SSH_KEY_PATH.pub"
        echo "SSH key generated at $SSH_KEY_PATH"
        echo "Public key for Git repository setup:"
        cat "$SSH_KEY_PATH.pub"
      fi

      ${pkgs.gnused}/bin/sed -i '/\[auth\]/a ssh_key_path = "/var/lib/crystal-forge/.ssh/id_ed25519"' "${generatedConfigPath}"
    ''}

    chmod 600 "${generatedConfigPath}"
  '';

  serverScript = pkgs.writeShellScript "crystal-forge-server" ''
    export CRYSTAL_FORGE_CONFIG="${generatedConfigPath}"
    exec ${pkgs.crystal-forge.server}/bin/server "$@"
  '';

  builderScript = pkgs.writeShellScript "crystal-forge-builder" ''
    set -euo pipefail
    export CRYSTAL_FORGE_CONFIG="${generatedConfigPath}"
    export TMPDIR="/var/lib/crystal-forge/tmp"
    export HOME="/var/lib/crystal-forge"

    cleanup_old_builds() {
      find /var/lib/crystal-forge/workdir -name "result*" -type l -mtime +1 -delete 2>/dev/null || true
      find /var/lib/crystal-forge/tmp -type f -mtime +1 -delete 2>/dev/null || true
    }
    trap cleanup_old_builds EXIT INT TERM

    mkdir -p /var/lib/crystal-forge/workdir
    cd /var/lib/crystal-forge/workdir
    cleanup_old_builds

    export NIX_BUILD_CORES="${toString cfg.build.cores}"
    export NIX_MAX_JOBS="${toString cfg.build.max_jobs}"

    exec ${pkgs.crystal-forge.server}/bin/builder "$@"
  '';

  agentScript = pkgs.writeShellScript "crystal-forge-agent" ''
    export CRYSTAL_FORGE_CONFIG="${generatedConfigPath}"
    exec ${pkgs.crystal-forge.agent}/bin/agent "$@"
  '';
in {
  options.services.crystal-forge = {
    enable = lib.mkEnableOption "Crystal Forge service(s)";

    log_level = lib.mkOption {
      type = lib.types.enum ["off" "error" "warn" "info" "debug" "trace"];
      default = "info";
      description = "Log level for Crystal Forge services";
    };

    configPath = lib.mkOption {
      type = lib.types.path;
      default = generatedConfigPath;
      readOnly = true;
      description = "Path to the generated config.toml file";
    };

    local-database = lib.mkOption {
      type = lib.types.bool;
      default = true;
      description = "Enable local PostgreSQL setup for Crystal Forge";
    };

    database = {
      host = lib.mkOption {
        type = lib.types.str;
        default = "/run/postgresql";
        description = "Database host (use socket path for local connections)";
      };
      port = lib.mkOption {
        type = lib.types.port;
        default = 5432;
        description = "Database port";
      };
      user = lib.mkOption {
        type = lib.types.str;
        default = "crystal_forge";
        description = "Database user";
      };
      password = lib.mkOption {
        type = lib.types.str;
        default = "password";
        description = "Database password (only used if passwordFile is null)";
      };
      passwordFile = lib.mkOption {
        type = lib.types.nullOr lib.types.path;
        default = null;
        description = "Path to file containing database password";
      };
      name = lib.mkOption {
        type = lib.types.str;
        default = "crystal_forge";
        description = "Database name";
      };
    };

    flakes = {
      watched = lib.mkOption {
        type = lib.types.listOf (lib.types.submodule {
          options = {
            name = lib.mkOption {
              type = lib.types.str;
              description = "Name identifier for the flake";
            };
            repo_url = lib.mkOption {
              type = lib.types.str;
              description = "Repository URL of the flake";
            };
            auto_poll = lib.mkOption {
              type = lib.types.bool;
              description = "Automatically poll for new commits";
            };
            initial_commit_depth = lib.mkOption {
              type = lib.types.int;
              default = 5;
              description = "How many commits in the past to monitor when initializing the flake monitor";
            };
          };
        });
        default = [];
        description = "List of flakes to watch for changes";
        example = [
          {
            name = "dotfiles";
            repo_url = "git+https://gitlab.com/usmcamp0811/dotfiles";
            auto_poll = false;
          }
        ];
      };
      flake_polling_interval = lib.mkOption {
        type = lib.types.str;
        default = "10m";
        description = "Interval between flake polling checks";
      };
      commit_evaluation_interval = lib.mkOption {
        type = lib.types.str;
        default = "1m";
        description = "Interval between commit evaluation checks";
      };
      build_processing_interval = lib.mkOption {
        type = lib.types.str;
        default = "1m";
        description = "Interval between build processing checks";
      };
    };

    auth = {
      ssh_key_path = lib.mkOption {
        type = lib.types.nullOr lib.types.path;
        default = null;
        description = "Path to SSH private key for Git authentication. If null, SSH keys will be generated automatically.";
      };
      ssh_known_hosts_path = lib.mkOption {
        type = lib.types.nullOr lib.types.path;
        default = null;
        description = "Path to SSH known_hosts file. If null, defaults to /var/lib/crystal-forge/.ssh/known_hosts";
      };
      netrc_path = lib.mkOption {
        type = lib.types.nullOr lib.types.path;
        default = null;
        description = "Path to .netrc file for HTTPS Git authentication. If null, defaults to /var/lib/crystal-forge/.netrc";
      };
      ssh_disable_strict_host_checking = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Whether to disable strict host key checking for SSH";
      };
    };
    build = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = cfg.server.enable;
        description = "Crystal Forge Builder";
      };
      cores = lib.mkOption {
        type = lib.types.ints.positive;
        default = 1;
        description = "Maximum CPU cores to use per build job";
      };
      max_jobs = lib.mkOption {
        type = lib.types.ints.positive;
        default = 1;
        description = "Maximum number of concurrent build jobs";
      };
      use_substitutes = lib.mkOption {
        type = lib.types.bool;
        default = true;
        description = "Whether to use binary substitutes/caches";
      };
      offline = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Build in offline mode (no network access)";
      };
      poll_interval = lib.mkOption {
        type = lib.types.str;
        default = "5m";
        description = "Interval between checking for new build jobs";
      };
      max_silent_time = lib.mkOption {
        type = lib.types.str;
        default = "1h";
        description = "Maximum time a build can be silent before timing out";
      };
      timeout = lib.mkOption {
        type = lib.types.str;
        default = "2h";
        description = "Maximum total time for a build before timing out";
      };
      sandbox = lib.mkOption {
        type = lib.types.bool;
        default = true;
        description = "Enable sandbox for builds";
      };

      max_concurrent_derivations = lib.mkOption {
        type = lib.types.int;
        default = 8;
        description = "Maximum concurrent dry run derivations to process";
      };

      # Systemd resource controls
      use_systemd_scope = lib.mkOption {
        type = lib.types.bool;
        default = true;
        description = "Whether to use systemd-run for resource isolation";
      };
      systemd_memory_max = lib.mkOption {
        type = lib.types.nullOr lib.types.str;
        default = "32G";
        description = "Memory limit for systemd scope (e.g., '4G', '2048M')";
      };
      systemd_cpu_quota = lib.mkOption {
        type = lib.types.nullOr lib.types.ints.positive;
        default = 800;
        description = "CPU quota as percentage (e.g., 300 for 3 cores worth)";
      };
      systemd_timeout_stop_sec = lib.mkOption {
        type = lib.types.nullOr lib.types.ints.positive;
        default = 600;
        description = "Timeout for systemd scope stop operation in seconds";
      };
      systemd_properties = lib.mkOption {
        type = lib.types.listOf lib.types.str;
        default = [
          "MemorySwapMax=2G"
          "TasksMax=3000"
        ];
        description = "Additional systemd properties to set";
        example = [
          "MemorySwapMax=2G"
          "TasksMax=3000"
          "IOWeight=100"
        ];
      };
    };

    vulnix = {
      timeout = lib.mkOption {
        type = lib.types.str;
        default = "5m";
        description = "Timeout for vulnix scans";
      };
      max_retries = lib.mkOption {
        type = lib.types.ints.unsigned;
        default = 5;
        description = "Max retries";
      };
      enable_whitelist = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Enable whitelist";
      };
      extra_args = lib.mkOption {
        type = lib.types.listOf lib.types.str;
        default = [];
        description = "Extra args";
      };
      whitelist_path = lib.mkOption {
        type = lib.types.nullOr lib.types.path;
        default = null;
        description = "Whitelist path";
      };
      poll_interval = lib.mkOption {
        type = lib.types.str;
        default = "1m";
        description = "Polling interval for CVE jobs";
      };
    };

    cache = {
      cache_type = lib.mkOption {
        type = lib.types.enum ["S3" "Attic" "Http" "Nix"];
        default = "Nix";
        description = "Type of cache to use";
      };
      push_to = lib.mkOption {
        type = lib.types.nullOr lib.types.str;
        default = null;
        description = "Cache URI to push to";
      };
      push_after_build = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Push after build";
      };
      signing_key = lib.mkOption {
        type = lib.types.nullOr lib.types.path;
        default = null;
        description = "Signing key path";
      };
      compression = lib.mkOption {
        type = lib.types.nullOr lib.types.str;
        default = null;
        description = "Compression method";
      };
      push_filter = lib.mkOption {
        type = lib.types.nullOr (lib.types.listOf lib.types.str);
        default = null;
        description = "Push filter";
      };
      parallel_uploads = lib.mkOption {
        type = lib.types.ints.positive;
        default = 4;
        description = "Parallel uploads";
      };
      # S3-specific options
      s3_region = lib.mkOption {
        type = lib.types.nullOr lib.types.str;
        default = null;
        description = "S3 region for cache";
      };
      s3_profile = lib.mkOption {
        type = lib.types.nullOr lib.types.str;
        default = null;
        description = "AWS profile to use for S3 cache";
      };
      # Attic-specific options
      attic_token = lib.mkOption {
        type = lib.types.nullOr lib.types.str;
        default = null;
        description = "Attic authentication token";
      };
      attic_cache_name = lib.mkOption {
        type = lib.types.nullOr lib.types.str;
        default = null;
        description = "Attic cache name";
      };
      # Retry configuration
      max_retries = lib.mkOption {
        type = lib.types.ints.unsigned;
        default = 3;
        description = "Maximum retry attempts for cache operations";
      };
      retry_delay_seconds = lib.mkOption {
        type = lib.types.ints.unsigned;
        default = 5;
        description = "Delay between retry attempts in seconds";
      };
      poll_interval = lib.mkOption {
        type = lib.types.ints.unsigned;
        default = 5;
        description = "Delay between cache push attempts in seconds";
      };
    };
    deployment = {
      max_deployment_age_minutes = lib.mkOption {
        type = lib.types.ints.unsigned;
        default = 30;
        description = "Maximum age in minutes for deployments to be considered valid";
      };
      dry_run_first = lib.mkOption {
        type = lib.types.bool;
        default = true;
        description = "Perform a dry run before actual deployment";
      };
      fallback_to_local_build = lib.mkOption {
        type = lib.types.bool;
        default = false;
        description = "Fallback to local build if remote build fails";
      };
      deployment_timeout_minutes = lib.mkOption {
        type = lib.types.ints.unsigned;
        default = 60;
        description = "Timeout for deployment operations in minutes";
      };
      cache_url = lib.mkOption {
        type = lib.types.nullOr lib.types.str;
        default = null;
        description = "Cache URL for deployment artifacts";
      };
      cache_public_key = lib.mkOption {
        type = lib.types.nullOr lib.types.str;
        default = null;
        description = "Cache Public Key for deployment artifacts";
      };
      deployment_poll_interval = lib.mkOption {
        type = lib.types.str;
        default = "15m";
        description = "Interval between deployment polling checks";
      };
    };
    systems = lib.mkOption {
      type = lib.types.listOf (lib.types.submodule {
        options = {
          hostname = lib.mkOption {
            type = lib.types.str;
            description = "System hostname";
          };
          public_key = lib.mkOption {
            type = lib.types.str;
            description = "Base64-encoded Ed25519 public key";
          };
          environment = lib.mkOption {
            type = lib.types.str;
            description = "Environment name";
          };
          flake_name = lib.mkOption {
            type = lib.types.nullOr lib.types.str;
            default = null;
            description = "Flake ref name";
          };
          desired_target = lib.mkOption {
            type = lib.types.nullOr lib.types.str;
            default = null;
            description = "Desired derivation hash for system";
          };
          deployment_policy = lib.mkOption {
            type = lib.types.enum ["manual" "auto_latest" "pinned"];
            default = "manual";
            description = "Deployment policy for the system";
          };
        };
      });
      default = [];
      description = "Systems to register with Crystal Forge";
      example = [
        {
          hostname = "myhost";
          public_key = "base64encodedkey";
          environment = "production";
          flake_name = "dotfiles";
          desired_target = null;
          deployment_policy = "manual";
        }
      ];
    };

    environments = lib.mkOption {
      type = lib.types.listOf (lib.types.submodule {
        options = {
          name = lib.mkOption {
            type = lib.types.str;
            description = "Environment name";
          };
          description = lib.mkOption {
            type = lib.types.str;
            description = "Description";
          };
          is_active = lib.mkOption {
            type = lib.types.bool;
            description = "Active flag";
          };
          risk_profile = lib.mkOption {
            type = lib.types.str;
            description = "Risk profile";
          };
          compliance_level = lib.mkOption {
            type = lib.types.str;
            description = "Compliance level";
          };
        };
      });
      default = [];
      description = "List of environments";
      example = [
        {
          name = "dev";
          description = "Development environment for Crystal Forge agents and evaluation";
          is_active = true;
          risk_profile = "LOW";
          compliance_level = "NONE";
        }
      ];
    };

    server = {
      enable = lib.mkEnableOption "Crystal Forge Server";
      host = lib.mkOption {
        type = lib.types.str;
        default = "127.0.0.1";
        description = "Server bind address";
      };
      port = lib.mkOption {
        type = lib.types.port;
        default = 3000;
        description = "Server port";
      };
    };

    client = {
      enable = lib.mkEnableOption "Crystal Forge Agent";
      server_host = lib.mkOption {
        type = lib.types.str;
        default = "127.0.0.1";
        description = "Server hostname";
      };
      server_port = lib.mkOption {
        type = lib.types.port;
        default = 3000;
        description = "Server port";
      };
      private_key = lib.mkOption {
        type = lib.types.path;
        description = "Path to Ed25519 private key file";
      };
    };
    env-file = lib.mkOption {
      type = lib.types.str;
      default = "/var/lib/crystal-forge/.config/crystal-forge-attic.env";
      description = "Path to env file";
    };
  };

  config = lib.mkIf cfg.enable {
    nix.settings = lib.mkIf (cfg.server.enable || cfg.build.enable || cfg.client.enable) {
      experimental-features = ["nix-command" "flakes"];
      allowed-users = ["root" "crystal-forge"];
      trusted-users = ["root" "crystal-forge"];

      # Add substituters based on cache configuration
      substituters = lib.mkIf (cfg.cache.push_to != null) [
        cfg.cache.push_to
      ];
      trusted-public-keys = lib.mkIf (cfg.deployment.cache_public_key != null) [
        cfg.deployment.cache_public_key
      ];
    };

    users.users.crystal-forge = lib.mkIf (cfg.server.enable || cfg.build.enable) {
      description = "Crystal Forge service user";
      isSystemUser = true;
      group = "crystal-forge";
      home = "/var/lib/crystal-forge";
      createHome = true;
      # extraGroups is optional for daemon-style nix; keep empty unless needed.
      # extraGroups = [ "nixbld" ];
    };

    users.groups.crystal-forge = {};

    systemd.tmpfiles.rules = [
      "d /var/lib/crystal-forge 0755 crystal-forge crystal-forge -"
      "d /var/lib/crystal-forge/.cache 0755 crystal-forge crystal-forge -"
      "d /var/lib/crystal-forge/.cache/nix 0755 crystal-forge crystal-forge -"
      "d /var/lib/crystal-forge/tmp 0755 crystal-forge crystal-forge -"
      "d /var/lib/crystal-forge/builds 0755 crystal-forge crystal-forge -"
      "d /var/lib/crystal-forge/workdir 0755 crystal-forge crystal-forge -"
      "d /var/lib/crystal-forge/.ssh 0700 crystal-forge crystal-forge -"
      "f /var/lib/crystal-forge/config.toml 0600 crystal-forge crystal-forge - -"
      "d /var/lib/crystal-forge/.config 0755 crystal-forge crystal-forge -"
      "d /var/lib/crystal-forge/.config/attic 0755 crystal-forge crystal-forge -"
      "d /var/lib/crystal-forge/.config/nix 0755 crystal-forge crystal-forge -"
      "d /var/lib/crystal-forge/.local 0755 crystal-forge crystal-forge -"
      "d /var/lib/crystal-forge/.local/share 0755 crystal-forge crystal-forge -"
      "d /var/cache/crystal-forge/gc-roots 0755 crystal-forge crystal-forge -" # <-- ADD THIS
      "Z /var/lib/crystal-forge/ 0755 crystal-forge crystal-forge -"
    ];

    systemd.slices.crystal-forge-builds = lib.mkIf cfg.build.enable {
      description = "Crystal Forge Build Operations";
      sliceConfig = {
        # Use build config values or sensible defaults for the slice
        MemoryMax =
          lib.mkIf (cfg.build.systemd_memory_max != null)
          (cfg.build.systemd_memory_max + ""); # Ensure string conversion
        MemoryHigh =
          lib.mkIf (cfg.build.systemd_memory_max != null)
          (let
            # Calculate 75% of max memory for "high" threshold
            memStr = cfg.build.systemd_memory_max;
            memVal =
              if lib.hasSuffix "G" memStr
              then toString (lib.toInt (lib.removeSuffix "G" memStr) * 3 / 4) + "G"
              else if lib.hasSuffix "M" memStr
              then toString (lib.toInt (lib.removeSuffix "M" memStr) * 3 / 4) + "M"
              else memStr;
          in
            memVal);
        CPUQuota =
          lib.mkIf (cfg.build.systemd_cpu_quota != null)
          (toString cfg.build.systemd_cpu_quota + "%");
        TasksMax = "200"; # Keep this as a reasonable default
      };
    };

    services.postgresql = lib.mkIf (cfg.local-database && cfg.server.enable) {
      enable = true;
      ensureDatabases = [cfg.database.name];
      ensureUsers = [
        {
          name = cfg.database.user;
          ensureDBOwnership = true;
          ensureClauses.login = true;
        }
      ];
      identMap = ''
        crystal-forge-map crystal-forge ${cfg.database.user}
      '';
      authentication = lib.mkAfter ''
        local  ${cfg.database.name}  ${cfg.database.user}  peer map=crystal-forge-map
        local  ${cfg.database.name}  ${cfg.database.user}  trust
        host   ${cfg.database.name}  ${cfg.database.user}  127.0.0.1/32  trust
        host   ${cfg.database.name}  ${cfg.database.user}  ::1/128       trust
      '';
    };

    systemd.services."crystal-forge-postgres-jobs" = lib.mkIf cfg.server.enable {
      description = "Crystal Forge Postgres Jobs";
      after = ["postgresql.service"];
      wantedBy = ["multi-user.target"];

      serviceConfig = {
        Type = "oneshot";
        User = "crystal-forge";
        Group = "crystal-forge";
        StateDirectory = "crystal-forge";
        RuntimeDirectory = "crystal-forge";
        CacheDirectory = "crystal-forge-nix";
      };

      environment = {
        DB_HOST = cfg.database.host;
        DB_PORT = toString cfg.database.port;
        DB_NAME = cfg.database.name;
        DB_USER = cfg.database.user;
        DB_PASSWORD = lib.mkIf (cfg.database.passwordFile == null) cfg.database.password;
        JOB_DIR = "${pkgs.crystal-forge.run-postgres-jobs}/jobs";
        # disable registry and per-user nix.conf for deterministic evals
        NIX_REGISTRY = "/dev/null";
        NIX_CONFIG_DIR = "/dev/null";
      };

      script =
        lib.optionalString (cfg.database.passwordFile != null) ''
          export DB_PASSWORD="$(cat ${cfg.database.passwordFile})"
          exec ${pkgs.crystal-forge.run-postgres-jobs}/bin/run-postgres-jobs
        ''
        + lib.optionalString (cfg.database.passwordFile == null) ''
          exec ${pkgs.crystal-forge.run-postgres-jobs}/bin/run-postgres-jobs
        '';
    };

    systemd.timers."crystal-forge-postgres-jobs" = lib.mkIf cfg.server.enable {
      description = "Run Crystal Forge Postgres Jobs daily at midnight";
      wantedBy = ["timers.target"];
      timerConfig = {
        OnCalendar = "*-*-* 00:00:00";
        Persistent = true;
      };
    };

    security.polkit.enable = true;
    security.polkit.extraConfig = ''
      polkit.addRule(function(action, subject) {
        if (subject.user === "crystal-forge") {
          if (action.id === "org.freedesktop.systemd1.manage-units" ||
              action.id === "org.freedesktop.systemd1.set-property") {
            return polkit.Result.YES;
          }
        }
      });
    '';

    systemd.services.crystal-forge-builder = lib.mkIf cfg.build.enable (let
      # Parse cfg.build.systemd_properties (["Environment=FOO=bar" "IOWeight=100" â€¦])
      parsed =
        lib.foldl' (
          acc: prop: let
            kv = lib.splitString "=" prop;
            key = lib.elemAt kv 0;
            val = lib.concatStringsSep "=" (lib.drop 1 kv);
          in
            if key == "Environment"
            then acc // {env = (acc.env or []) ++ [val];}
            else acc // {svc = (acc.svc or {}) // {${key} = val;};}
        ) {
          env = [];
          svc = {};
        }
        cfg.build.systemd_properties;

      envFromProps = builtins.listToAttrs (map (
          s: let
            p = lib.splitString "=" s;
          in {
            name = lib.elemAt p 0;
            value = lib.concatStringsSep "=" (lib.drop 1 p);
          }
        )
        parsed.env);
    in {
      description = "Crystal Forge Builder";
      wantedBy = ["multi-user.target"];
      after = lib.optional cfg.local-database "postgresql.service";
      wants = lib.optional cfg.local-database "postgresql.service";

      path = with pkgs;
        [nix git vulnix systemd nix-fast-build nix-eval-jobs]
        ++ lib.optional (cfg.cache.cache_type == "Attic") attic-client;

      # Merge existing env with any Environment=â€¦ pairs from systemd_properties
      environment = lib.mkMerge [
        {
          RUST_LOG = cfg.log_level;
          NIX_REMOTE = "daemon";
          # NIX_USER_CACHE_DIR = "/var/cache/crystal-forge-nix";
          TMPDIR = "/var/lib/crystal-forge/tmp";
          XDG_RUNTIME_DIR = "/run/crystal-forge";
          XDG_CONFIG_HOME = "/var/lib/crystal-forge/.config";
          HOME = "/var/lib/crystal-forge";
          # disable registry and per-user nix.conf for deterministic evals
          NIX_REGISTRY = "/dev/null";
          NIX_CONFIG_DIR = "/dev/null";
        }
        # Add Attic-specific environment variables if using Attic cache
        (lib.mkIf (cfg.cache.cache_type == "Attic") {
            # Force these to be available even if not in envFromProps
            ATTIC_SERVER_URL = envFromProps.ATTIC_SERVER_URL or "http://atticCache:8080";
            ATTIC_REMOTE_NAME = envFromProps.ATTIC_REMOTE_NAME or "local";
            # Only set ATTIC_TOKEN if it's provided
          }
          // lib.optionalAttrs (envFromProps ? ATTIC_TOKEN) {
            ATTIC_TOKEN = envFromProps.ATTIC_TOKEN;
          })
        envFromProps
      ];

      preStart = ''
        ${configScript}
        mkdir -p /run/crystal-forge
        mkdir -p /var/lib/crystal-forge/.config/attic

        # Ensure proper ownership - do this AFTER creating all directories
        chown -R crystal-forge:crystal-forge /var/lib/crystal-forge/.cache
        chown -R crystal-forge:crystal-forge /var/lib/crystal-forge/.config
        # Ensure proper permissions
        chmod -R 755 /var/lib/crystal-forge/.cache
        chmod -R 755 /var/lib/crystal-forge/.config

        # Source the attic environment if it exists
        if [ -f ${cfg.env-file} ]; then
          echo "Loading Attic environment variables from ${cfg.env-file}"
          set -a
          source ${cfg.env-file}
          set +a

          # Verify the environment was loaded
          echo "ATTIC_SERVER_URL: ''${ATTIC_SERVER_URL:-NOT_SET}"
          echo "ATTIC_REMOTE_NAME: ''${ATTIC_REMOTE_NAME:-NOT_SET}"
          echo "ATTIC_TOKEN: ''${ATTIC_TOKEN:+SET}"
        fi

        # Test attic configuration as the crystal-forge user
        echo "Testing Attic configuration..."
        runuser -u crystal-forge -- env \
          HOME="/var/lib/crystal-forge" \
          XDG_CONFIG_HOME="/var/lib/crystal-forge/.config" \
          ATTIC_SERVER_URL="''${ATTIC_SERVER_URL:-}" \
          ATTIC_TOKEN="''${ATTIC_TOKEN:-}" \
          ATTIC_REMOTE_NAME="''${ATTIC_REMOTE_NAME:-}" \
          attic login list || echo "Attic configuration test failed"
      '';

      # Splice arbitrary unit properties (e.g., IOWeight=100, TasksMax=3000) parsed above
      serviceConfig =
        {
          Type = "exec";
          ExecStart = builderScript;
          User = "crystal-forge";
          Group = "crystal-forge";
          Slice = "crystal-forge-builds.slice";

          StateDirectory = "crystal-forge";
          StateDirectoryMode = "0750";
          RuntimeDirectory = "crystal-forge";
          RuntimeDirectoryMode = "0700";
          CacheDirectory = "crystal-forge-nix";
          CacheDirectoryMode = "0750";
          WorkingDirectory = "/var/lib/crystal-forge/workdir";

          # When this service stops, kill all children
          KillMode = "control-group";

          # Make sure we load the environment file
          EnvironmentFile = [
            "-${cfg.env-file}"
            "-/var/lib/crystal-forge/.config/crystal-forge-attic.env"
          ];

          NoNewPrivileges = true;
          ProtectSystem = "no";
          ProtectHome = false;
          PrivateTmp = true;
          ProtectKernelTunables = true;
          ProtectKernelModules = true;
          ProtectControlGroups = true;

          ReadWritePaths = [
            "/var/lib/crystal-forge"
            "/tmp"
            "/run/crystal-forge"
            "/var/cache/crystal-forge-nix"
            "/var/cache/crystal-forge"
            "/var/lib/crystal-forge/.cache"
            "/nix/var/nix/daemon-socket"
          ];
          ReadOnlyPaths = ["/etc/nix" "/etc/ssl/certs"];

          Restart = "always";
          RestartSec = 5;
        }
        // parsed.svc;
    });

    systemd.services.crystal-forge-server = lib.mkIf cfg.server.enable {
      description = "Crystal Forge Server";
      wantedBy = ["multi-user.target"];
      after = lib.optional cfg.local-database "postgresql.service";
      wants = lib.optional cfg.local-database "postgresql.service";

      path = with pkgs; [
        nix
        git
        nix-fast-build
        nix-eval-jobs
        coreutils
        findutils
        gnused
        gnugrep
      ];

      environment = {
        # Core runtime
        RUST_LOG = cfg.log_level;
        TZDIR = "${pkgs.tzdata}/share/zoneinfo";
        LOCALE_ARCHIVE = "${pkgs.glibcLocales}/lib/locale/locale-archive";

        # --- Critical Nix environment for deterministic evaluation ---
        # Use the daemon socket for evaluation
        NIX_REMOTE = "daemon";

        # Completely isolate from user registries/config
        HOME = "/var/lib/crystal-forge";
        XDG_CONFIG_HOME = "/var/lib/crystal-forge/.config";
        NIX_REGISTRY = "/dev/null";
        NIX_CONFIG_DIR = "/dev/null";
        NIX_USER_CONF_FILES = "/dev/null";

        # Enable flakes and nix-command â€” exactly as in your manual test
        NIX_CONFIG = ''
          experimental-features = nix-command flakes
          flake-registry =
        '';

        # Required to allow git+ssh or https fetches
        GIT_SSH_COMMAND = "ssh -i /var/lib/crystal-forge/.ssh/id_ed25519 -o UserKnownHostsFile=/var/lib/crystal-forge/.ssh/known_hosts -o StrictHostKeyChecking=yes";

        # Optional: specify cache location for nix-eval-jobs
        NIX_USER_CACHE_DIR = "/var/cache/crystal-forge-nix";
      };

      preStart = ''
        mkdir -p /run/crystal-forge
        mkdir -p /var/lib/crystal-forge/.config/attic
        chown -R crystal-forge:crystal-forge /var/lib/crystal-forge/.cache
        chown -R crystal-forge:crystal-forge /var/lib/crystal-forge/.config
        chmod -R 755 /var/lib/crystal-forge/.cache
        chmod -R 755 /var/lib/crystal-forge/.config
      '';

      serviceConfig = {
        Type = "exec";
        ExecStart = serverScript;
        User = "crystal-forge";
        Group = "crystal-forge";
        WorkingDirectory = "/var/lib/crystal-forge";

        # Filesystem permissions
        StateDirectory = "crystal-forge";
        StateDirectoryMode = "0750";
        RuntimeDirectory = "crystal-forge";
        RuntimeDirectoryMode = "0700";
        CacheDirectory = "crystal-forge-nix";
        CacheDirectoryMode = "0750";

        # Read/write permissions
        ReadWritePaths = [
          "/var/lib/crystal-forge"
          "/var/lib/crystal-forge/.cache"
          "/tmp"
          "/run/crystal-forge"
          "/var/cache/crystal-forge"
          "/var/cache/crystal-forge-nix"
          "/nix/var/nix/daemon-socket"
        ];

        # Security isolation
        NoNewPrivileges = true;
        PrivateTmp = true;
        ProtectSystem = "no";
        ProtectHome = false;
        ProtectKernelTunables = true;
        ProtectKernelModules = true;
        ProtectControlGroups = true;

        Restart = "always";
        RestartSec = 5;
      };
    };

    systemd.services.crystal-forge-agent = lib.mkIf cfg.client.enable {
      description = "Crystal Forge Agent";
      wantedBy = ["multi-user.target"];
      after = lib.optional cfg.server.enable "crystal-forge-server.service";

      path = with pkgs; [
        nix-eval-jobs
        nix-fast-build
        coreutils
        zfs
        util-linux
        iproute2
        nettools
        pciutils
        usbutils
        dmidecode
        procps
        parted
        systemd
        gawk
        gnused
        gnugrep
        findutils
        vulnix
        nix
        nixos-rebuild
        git
      ];
      environment = {
        RUST_LOG = cfg.log_level;
        CRYSTAL_FORGE__CLIENT__SERVER_HOST = cfg.client.server_host;
        CRYSTAL_FORGE__CLIENT__SERVER_PORT = toString cfg.client.server_port;
        CRYSTAL_FORGE__CLIENT__PRIVATE_KEY = cfg.client.private_key;
        # make nix/git caches writable for the agent
        HOME = "/var/lib/crystal-forge-agent";
        XDG_CACHE_HOME = "/var/lib/crystal-forge-agent/.cache";
        NIX_USER_CACHE_DIR = "/var/cache/crystal-forge-agent";
      };

      serviceConfig = {
        Type = "exec";
        ExecStart = agentScript;
        User = "root";
        Group = "root";

        # Keep state + runtime under /var/lib and /run
        StateDirectory = "crystal-forge-agent";
        StateDirectoryMode = "0750";
        RuntimeDirectory = "crystal-forge-agent";
        RuntimeDirectoryMode = "0700";
        WorkingDirectory = "/var/lib/crystal-forge-agent";

        CacheDirectory = "crystal-forge-agent";

        NoNewPrivileges = true;
        ProtectSystem = "strict";
        ProtectHome = false;

        # Allow writes where we actually need them
        ReadWritePaths = [
          "/nix/var/nix/profiles"
          "/nix/var/nix/gcroots"
          "/boot"
          "/var/lib/crystal-forge-agent"
          "/var/cache/crystal-forge-agent"
          "/tmp"
          "/run/crystal-forge-agent"
        ];
        # Also ensure read-only access to CA bundle (good practice):
        ReadOnlyPaths = ["/etc/ssl/certs"];
        PrivateTmp = true;
        Restart = "always";
        RestartSec = 5;
      };
    };

    assertions = [
      {
        assertion = cfg.client.enable -> (cfg.client.private_key != null);
        message = "Crystal Forge client requires a private key file";
      }
      {
        assertion = cfg.database.passwordFile != null -> cfg.database.password == "";
        message = "Cannot specify both database.password and database.passwordFile";
      }
      {
        assertion = cfg.server.enable || cfg.client.enable || cfg.build.enable;
        message = "At least one of server or client must be enabled";
      }
    ];
  };
}
